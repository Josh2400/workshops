{
  "hash": "290aae0eaf09b0a9d055d6eb1d428a57",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"5 - Feature engineering: splines, target encoding and dates\"\nsubtitle: \"Getting More Out of Feature Engineering and Tuning for Machine Learning\"\nformat:\n  revealjs: \n    slide-number: true\n    footer: <https://workshops.tidymodels.org>\n    include-before-body: header.html\n    include-after-body: footer-annotations.html\n    theme: [default, tidymodels.scss]\n    width: 1280\n    height: 720\nknitr:\n  opts_chunk: \n    echo: true\n    collapse: true\n    comment: \"#>\"\n---\n\n\n\n\n\n## Getting set up ![](hexes/tidymodels.png){.absolute top=-20 right=0 width=\"64\" height=\"74.24\"} ![](hexes/recipes.png){.absolute top=-20 right=64 width=\"64\" height=\"74.24\"} ![](hexes/embed.png){.absolute top=-20 right=128 width=\"64\" height=\"74.24\"}\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidymodels)\nlibrary(embed)\nlibrary(extrasteps)\n\ntidymodels_prefer()\ntheme_set(theme_bw())\noptions(pillar.advice = FALSE, pillar.min_title_chars = Inf)\n```\n:::\n\n\n\n# Hotel data {background-color=\"#ceeaee\"}\n\n## Hotel rates data set\n\nRegression data set for predicting the average daily rate for a room, for \"Resort Hotel\". The `agent` and `company` use random names.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(hotel_rates)\n#> Rows: 15,402\n#> Columns: 28\n#> $ avg_price_per_room             <dbl> 110.00, 74.00, 81.90, 81.00, 112.20, 90â€¦\n#> $ lead_time                      <dbl> 241, 273, 248, 236, 243, 267, 94, 10, 1â€¦\n#> $ stays_in_weekend_nights        <dbl> 0, 2, 2, 2, 4, 2, 4, 0, 0, 0, 0, 0, 0, â€¦\n#> $ stays_in_week_nights           <dbl> 1, 5, 5, 5, 10, 5, 7, 1, 1, 1, 1, 1, 1,â€¦\n#> $ adults                         <dbl> 2, 2, 2, 2, 2, 2, 3, 2, 2, 2, 2, 2, 2, â€¦\n#> $ children                       <dbl> 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, â€¦\n#> $ babies                         <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, â€¦\n#> $ meal                           <fct> bed_and_breakfast, bed_and_breakfast, bâ€¦\n#> $ country                        <fct> prt, aus, gbr, prt, gbr, null, prt, espâ€¦\n#> $ market_segment                 <fct> online_travel_agent, offline_travel_ageâ€¦\n#> $ distribution_channel           <fct> ta_to, ta_to, ta_to, ta_to, ta_to, ta_tâ€¦\n#> $ is_repeated_guest              <dbl> 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, â€¦\n#> $ previous_cancellations         <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, â€¦\n#> $ previous_bookings_not_canceled <dbl> 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, â€¦\n#> $ reserved_room_type             <fct> a, a, a, a, a, a, f, e, h, a, a, g, a, â€¦\n#> $ assigned_room_type             <fct> c, a, c, a, a, a, f, f, h, e, e, g, e, â€¦\n#> $ booking_changes                <dbl> 0, 0, 1, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, â€¦\n#> $ agent                          <fct> devin_rivera_borrego, lia_nauth, jawharâ€¦\n#> $ company                        <fct> not_applicable, not_applicable, not_appâ€¦\n#> $ days_in_waiting_list           <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, â€¦\n#> $ customer_type                  <fct> transient, transient_party, transient, â€¦\n#> $ required_car_parking_spaces    <dbl> 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 1, 0, â€¦\n#> $ total_of_special_requests      <dbl> 1, 0, 0, 2, 0, 0, 1, 1, 0, 2, 2, 0, 2, â€¦\n#> $ arrival_date                   <date> 2016-07-02, 2016-07-02, 2016-07-02, 20â€¦\n#> $ arrival_date_num               <dbl> 2016.5, 2016.5, 2016.5, 2016.5, 2016.5,â€¦\n#> $ near_christmas                 <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, â€¦\n#> $ near_new_years                 <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, â€¦\n#> $ historical_adr                 <dbl> 104.9811, 104.9811, 104.9811, 104.9811,â€¦\n```\n:::\n\n\n\n::: footer\nAntonio, N., de Almeida, A., and Nunes, L. (2019). Hotel booking demand datasets. Data in Brief, 22, 41-49.\n:::\n\n## Hotel data splitting  ![](hexes/rsample.png){.absolute top=-20 right=0 width=\"64\" height=\"74.24\"}\n\nGenerally, you should always do data splitting. We are doing it here explicitly because some artifacts of splitting data become useful later on.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1234)\nhotel_split <- initial_split(hotel_rates)\nhotel_train <- training(hotel_split)\nhotel_test <- testing(hotel_split)\n```\n:::\n\n\n\n## Your turn\n\n![](images/parsnip-flagger.jpg){.absolute top=\"0\" right=\"0\" width=\"150\" height=\"150\"}\n\n*Load and explore the hotel_train data*\n\n*Comes loaded with the modeldata package*\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"countdown\" id=\"explore-hotels\" data-update-every=\"1\" tabindex=\"0\" style=\"right:0;bottom:0;\">\n<div class=\"countdown-controls\"><button class=\"countdown-bump-down\">&minus;</button><button class=\"countdown-bump-up\">&plus;</button></div>\n<code class=\"countdown-time\"><span class=\"countdown-digits minutes\">05</span><span class=\"countdown-digits colon\">:</span><span class=\"countdown-digits seconds\">00</span></code>\n</div>\n```\n\n:::\n:::\n\n\n\n## Nonlinear predictors\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](advanced-05-feature-engineering-part-two_files/figure-revealjs/arrival-date-num-vs-avg-price-per-room-1.svg)\n:::\n:::\n\n\n\n# Splines {background-color=\"#ec1763\"}\n\n## Splines\n\nIt is a way to transform a single numeric predictor into multiple numeric predictors, with the hope that the new numeric predictors are more linearly related to the outcome.\n\nMostly needed with linear models, but it should rarely hurt to use it.\n\nIf you've ever used `geom_smooth()` you have seen splines in action.\n\n::: {.absolute bottom=0 right=0}\n[FEAZ](https://feaz-book.com/numeric-splines) [FES](http://www.feat.engineering/numeric-one-to-many)\n:::\n\n## Splines explained\n\nA spline is a piecewise polynomial function.\n\nWe have 2 main parameters to worry about. Number of knots and the polynomial degree.\n\nThe domain of the predictor is split into `k` regions, with a knot between each, and a polynomial function is fit within each region, under the constraint that they touch each other at the knot.\n\n## knots: 1, degree: 1\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](advanced-05-feature-engineering-part-two_files/figure-revealjs/spline-knots-1-degree-1-1.svg)\n:::\n:::\n\n\n\n## knots: 2, degree: 1\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](advanced-05-feature-engineering-part-two_files/figure-revealjs/spline-knots-2-degree-1-1.svg)\n:::\n:::\n\n\n\n\n## knots: 5, degree: 1\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](advanced-05-feature-engineering-part-two_files/figure-revealjs/spline-knots-5-degree-1-1.svg)\n:::\n:::\n\n\n\n## knots: 5, degree: 2\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](advanced-05-feature-engineering-part-two_files/figure-revealjs/spline-knots-5-degree-2-1.svg)\n:::\n:::\n\n\n\n## knots: 5, degree: 3\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](advanced-05-feature-engineering-part-two_files/figure-revealjs/spline-knots-5-degree-3-1.svg)\n:::\n:::\n\n\n\n## knots: 9, degree: 3\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](advanced-05-feature-engineering-part-two_files/figure-revealjs/spline-knots-9-degree-3-1.svg)\n:::\n:::\n\n\n\n## B-Spline features visualized - degree: 3\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](advanced-05-feature-engineering-part-two_files/figure-revealjs/data-splines-1.svg)\n:::\n:::\n\n\n\n## Splines as numbers\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n\n\n| arrival_date_num| Spline Feature 1| Spline Feature 2| Spline Feature 3| Spline Feature 4| Spline Feature 5| Spline Feature 6|\n|----------------:|----------------:|----------------:|----------------:|----------------:|----------------:|----------------:|\n|         2017.619|             0.00|             0.00|             0.00|             0.03|             0.35|             0.62|\n|         2016.844|             0.15|             0.59|             0.26|             0.00|             0.00|             0.00|\n|         2016.702|             0.51|             0.40|             0.05|             0.00|             0.00|             0.00|\n|         2017.077|             0.00|             0.19|             0.67|             0.14|             0.00|             0.00|\n|         2016.861|             0.13|             0.58|             0.29|             0.00|             0.00|             0.00|\n|         2017.019|             0.00|             0.30|             0.62|             0.07|             0.00|             0.00|\n|         2017.123|             0.00|             0.11|             0.66|             0.23|             0.00|             0.00|\n\n\n:::\n:::\n\n\n\n## Splines pros and cons\n\n::: {.columns}\n::: {.column}\n\n### Pros\n\n- fast\n- easy to use\n- semi-interpretable\n\n:::\n::: {.column}\n\n### Cons\n\n- adds more columns\n- will need to select the number of columns\n- can be messy outside the range\n\n:::\n:::\n\n## Your turn\n\n![](images/parsnip-flagger.jpg){.absolute top=\"0\" right=\"0\" width=\"150\" height=\"150\"}\n\n*Apply B-splines to some variables using `step_spline_b()`*\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"countdown\" id=\"explore-step_spline_b\" data-update-every=\"1\" tabindex=\"0\" style=\"right:0;bottom:0;\">\n<div class=\"countdown-controls\"><button class=\"countdown-bump-down\">&minus;</button><button class=\"countdown-bump-up\">&plus;</button></div>\n<code class=\"countdown-time\"><span class=\"countdown-digits minutes\">03</span><span class=\"countdown-digits colon\">:</span><span class=\"countdown-digits seconds\">00</span></code>\n</div>\n```\n\n:::\n:::\n\n\n\n## Factors with many categories\n\n::: {.columns}\n::: {.column width=30%}\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhotel_train |>\n  count(country)\n#> # A tibble: 88 Ã— 2\n#>    country     n\n#>    <fct>   <int>\n#>  1 ago         7\n#>  2 and         1\n#>  3 are         3\n#>  4 arg        14\n#>  5 aus        31\n#>  6 aut        76\n#>  7 aze         2\n#>  8 bel       184\n#>  9 bgr         2\n#> 10 bhs         1\n#> # â„¹ 78 more rows\n```\n:::\n\n\n\n:::\n::: {.column width=35%}\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhotel_train |>\n  count(company)\n#> # A tibble: 157 Ã— 2\n#>    company                 n\n#>    <fct>               <int>\n#>  1 abdou_llc               2\n#>  2 afework_llc             5\n#>  3 alston_pbc              3\n#>  4 battle_llc             23\n#>  5 bennett_and_company     3\n#>  6 berhanu_pbc            53\n#>  7 biggers_llc             4\n#>  8 blasingime_llc          1\n#>  9 boddy_llc              16\n#> 10 boles_pbc               3\n#> # â„¹ 147 more rows\n```\n:::\n\n\n\n:::\n::: {.column width=35%}\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhotel_train |>\n  count(agent)\n#> # A tibble: 119 Ã— 2\n#>    agent                 n\n#>    <fct>             <int>\n#>  1 aaron_marquez         2\n#>  2 alexander_drake    1117\n#>  3 allen_her             1\n#>  4 anas_el_bashir        1\n#>  5 araseli_billy         1\n#>  6 arhab_al_islam        7\n#>  7 audray_tucker        38\n#>  8 bernice_baltierra    35\n#>  9 betzy_rodriguez      66\n#> 10 brayan_guerrero       2\n#> # â„¹ 109 more rows\n```\n:::\n\n\n\n:::\n:::\n\n## How do we handle them?\n\n. . .\n\nWe could:\n\n- Make the full set of indicator variables ðŸ˜³\n\n- Lump agents and companies that rarely occur into an \"other\" group\n\n- Use [feature hashing](https://www.tmwr.org/categorical.html#feature-hashing) to create a smaller set of indicator variables\n\n- Use target encoding to replace the `county`, `agent`, and `company` columns with the estimated effect of that predictor\n\n# Target encoding {background-color=\"#f37826\"}\n\n## Target encoding\n\n**Target encoding** (also called **mean encoding**, **likelihood encoding**, **impact encoding**, or **effect encoding**) is a supervised trained method that turns a single categorical predictor into a single numeric predictor.\n\nIt is often used to deal with categorical predictors with many levels, although it works regardless.\n\nSince it uses the outcome to train it, you need to make sure to use cross-validation to avoid overfitting.\n\n::: {.absolute bottom=0 right=0}\n[FEAZ](https://feaz-book.com/categorical-target) [FES](http://www.feat.engineering/categorical-supervised-encoding)\n:::\n\n## Target encoding motivation\n\nYou have a numeric outcome and a categorical predictor. And you want to transform each value of the categorical predictor into a value that best represents the outcome?\n\n. . .\n\n::: {.columns}\n::: {.column}\n\nWe calculate the mean of the outcome within each level of the predictor, and use that as the new value.\n\n::: {.callout-caution}\nDon't do just this! We are building up the method one thing at a time. Unregularized target encoding is really prone to overfitting.\n:::\n\n:::\n::: {.column}\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhotel_train |>\n  summarise(\n    mean = mean(avg_price_per_room),\n    .by = agent\n  )\n#> # A tibble: 119 Ã— 2\n#>    agent                 mean\n#>    <fct>                <dbl>\n#>  1 alexander_drake      144. \n#>  2 kaylae_maxedon        62.5\n#>  3 michael_mcdole        60.9\n#>  4 devin_rivera_borrego 126. \n#>  5 james_richards        78.6\n#>  6 estela_bonilla        41.9\n#>  7 charles_najera       109. \n#>  8 reema_el_tamer       118. \n#>  9 jawhara_al_azad       90.1\n#> 10 not_applicable        84.1\n#> # â„¹ 109 more rows\n```\n:::\n\n\n\n:::\n:::\n\n## Target encoding handling unseen levels\n\n::: {.callout-caution}\nDon't look at the testing data set. This is done for educational purposes.\n:::\n\n::: {.columns}\n::: {.column}\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhotel_train |>\n  count(agent, .drop = FALSE)\n#> # A tibble: 174 Ã— 2\n#>    agent                   n\n#>    <fct>               <int>\n#>  1 aaron_marquez           2\n#>  2 aayaat_al_farran        0\n#>  3 alanah_cook             0\n#>  4 alexander_drake      1117\n#>  5 allen_her               1\n#>  6 amirah_christian        0\n#>  7 anas_el_bashir          1\n#>  8 anna_beltran_moreno     0\n#>  9 anna_choi               0\n#> 10 araseli_billy           1\n#> # â„¹ 164 more rows\n```\n:::\n\n\n\n:::\n::: {.column}\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhotel_test |>\n  count(agent, .drop = FALSE)\n#> # A tibble: 174 Ã— 2\n#>    agent                   n\n#>    <fct>               <int>\n#>  1 aaron_marquez           1\n#>  2 aayaat_al_farran        0\n#>  3 alanah_cook             0\n#>  4 alexander_drake       367\n#>  5 allen_her               1\n#>  6 amirah_christian        0\n#>  7 anas_el_bashir          0\n#>  8 anna_beltran_moreno     0\n#>  9 anna_choi               0\n#> 10 araseli_billy           1\n#> # â„¹ 164 more rows\n```\n:::\n\n\n\n:::\n:::\n\n## Target encoding handling unseen levels\n\n::: {.columns}\n::: {.column}\n\nCalculate the global mean of the outcome and use it for cases that aren't seen in the training data set.\n\n<br>\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmean(hotel_train$avg_price_per_room)\n#> [1] 104.6039\n```\n:::\n\n\n\n:::\n::: {.column}\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhotel_train |>\n  summarise(\n    mean = mean(avg_price_per_room),\n    .by = agent\n  )\n#> # A tibble: 119 Ã— 2\n#>    agent                 mean\n#>    <fct>                <dbl>\n#>  1 alexander_drake      144. \n#>  2 kaylae_maxedon        62.5\n#>  3 michael_mcdole        60.9\n#>  4 devin_rivera_borrego 126. \n#>  5 james_richards        78.6\n#>  6 estela_bonilla        41.9\n#>  7 charles_najera       109. \n#>  8 reema_el_tamer       118. \n#>  9 jawhara_al_azad       90.1\n#> 10 not_applicable        84.1\n#> # â„¹ 109 more rows\n```\n:::\n\n\n\n:::\n:::\n\n## How do we handle low counts?\n\n::: {.columns}\n::: {.column}\n\nSome of the levels have very low counts. We can't have the same confidence in those means as the means calculated on high counts.\n\nWe use the global mean to account for 0 occurrences. Let us adjust the calculated mean by the global mean depending on the counts.\n\n:::\n::: {.column}\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhotel_train |>\n  summarise(\n    mean = mean(avg_price_per_room),\n    n = n(),\n    .by = agent\n  ) |>\n  arrange(agent)\n#> # A tibble: 119 Ã— 3\n#>    agent              mean     n\n#>    <fct>             <dbl> <int>\n#>  1 aaron_marquez     118.      2\n#>  2 alexander_drake   144.   1117\n#>  3 allen_her          65       1\n#>  4 anas_el_bashir     99       1\n#>  5 araseli_billy      40       1\n#>  6 arhab_al_islam     35       7\n#>  7 audray_tucker      76.0    38\n#>  8 bernice_baltierra  71.3    35\n#>  9 betzy_rodriguez    84.0    66\n#> 10 brayan_guerrero    37.5     2\n#> # â„¹ 109 more rows\n```\n:::\n\n\n\n:::\n:::\n\n## Partial pooling\n\nPartial pooling somewhat lowers the risk of overfitting since it tends to correct for agents with small sample sizes. It canâ€™t correct for improper data usage or data leakage, though. \n\n## Partial pooling results\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](advanced-05-feature-engineering-part-two_files/figure-revealjs/partial-pooling-1.svg)\n:::\n:::\n\n\n\n## Implentations\n\nWe have described this method solely based on analytical calculations ([`step_lencode()`](https://embed.tidymodels.org/reference/step_lencode.html)), but you could arrive at similar numbers using a model-based approach by fitting a no-intercept generalized linear model. A hierarchical version would induce partial pooling.\n\n- [`step_lencode_glm()`](https://embed.tidymodels.org/reference/step_lencode_glm.html)\n- [`step_lencode_bayes()`](https://embed.tidymodels.org/reference/step_lencode_bayes.html)\n- [`step_lencode_mixed()`](https://embed.tidymodels.org/reference/step_lencode_mixed.html)\n\n## Target encoding in recipes ![](hexes/recipes.png){.absolute top=-20 right=0 width=\"64\" height=\"74.24\"} ![](hexes/embed.png){.absolute top=-20 right=64 width=\"64\" height=\"74.24\"}\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrecipe(avg_price_per_room ~ ., data = hotel_train) |>\n  step_lencode(\n    agent, country, company,\n    outcome = vars(\"avg_price_per_room\"), smooth = TRUE,\n  ) |>\n  prep() |>\n  bake(NULL) |>\n  select(agent, country, company)\n#> # A tibble: 11,551 Ã— 3\n#>    agent country company\n#>    <dbl>   <dbl>   <dbl>\n#>  1 144.    108.     109.\n#>  2  77.2    83.4    109.\n#>  3  61.5    99.9    109.\n#>  4 126.    108.     109.\n#>  5 144.    108.     109.\n#>  6  79.9    73.8    109.\n#>  7 126.     99.9    109.\n#>  8  69.8   108.     109.\n#>  9 126.     99.9    109.\n#> 10 144.    108.     109.\n#> # â„¹ 11,541 more rows\n```\n:::\n\n\n\n## Your turn\n\n![](images/parsnip-flagger.jpg){.absolute top=\"0\" right=\"0\" width=\"150\" height=\"150\"}\n\n*Apply target encoding to the data set, see how it affects different predictors, not just the ones we listed here.*\n\n- `step_lencode()`\n- `step_lencode_glm()`\n- `step_lencode_bayes()`\n- `step_lencode_mixed()`\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"countdown\" id=\"explore-lencode\" data-update-every=\"1\" tabindex=\"0\" style=\"right:0;bottom:0;\">\n<div class=\"countdown-controls\"><button class=\"countdown-bump-down\">&minus;</button><button class=\"countdown-bump-up\">&plus;</button></div>\n<code class=\"countdown-time\"><span class=\"countdown-digits minutes\">03</span><span class=\"countdown-digits colon\">:</span><span class=\"countdown-digits seconds\">00</span></code>\n</div>\n```\n\n:::\n:::\n\n\n\n# Date time variables {background-color=\"#53b0c9\"}\n\n## Date time variables\n\nHow can we represent the date column `arrival_date` for our model?\n\n. . .\n\nWhen we use a date column in its native format, most models in R convert it to an integer.\n\n. . .\n\nWe can re-engineer it as:\n\n- Days since a reference date\n- Day of the week\n- Month\n- Year\n- Indicators for holidays\n\n::: notes\nThe main point is that we try to maximize performance with different versions of the predictors. \n\nMention that, for the Chicago data, the day or the week features are usually the most important ones in the model.\n:::\n\n::: {.absolute bottom=0 right=0}\n[FEAZ](https://feaz-book.com/datetime-extraction)\n:::\n\n## Your turn\n\n![](images/parsnip-flagger.jpg){.absolute top=\"0\" right=\"0\" width=\"150\" height=\"150\"}\n\n*Explore the `arrival_date` variable and its relation to `avg_price_per_room`*\n\n*The lubridate package might provide helpful*\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"countdown\" id=\"explore-arrival_date\" data-update-every=\"1\" tabindex=\"0\" style=\"right:0;bottom:0;\">\n<div class=\"countdown-controls\"><button class=\"countdown-bump-down\">&minus;</button><button class=\"countdown-bump-up\">&plus;</button></div>\n<code class=\"countdown-time\"><span class=\"countdown-digits minutes\">05</span><span class=\"countdown-digits colon\">:</span><span class=\"countdown-digits seconds\">00</span></code>\n</div>\n```\n\n:::\n:::\n\n\n\n## `arrival_date` date features\n\nusing `step_date( features = c(\"year\", \"month\", \"dow\", \"decimal\", \"mday\", \"doy\", \"week\", \"semester\", \"quarter\"))`\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n\n\n|arrival_date | year|month |dow |  decimal| mday| doy| week| semester| quarter|\n|:------------|----:|:-----|:---|--------:|----:|---:|----:|--------:|-------:|\n|2016-08-30   | 2016|Aug   |Tue | 2016.661|   30| 243|   35|        2|       3|\n|2016-10-22   | 2016|Oct   |Sat | 2016.806|   22| 296|   43|        2|       4|\n|2016-12-17   | 2016|Dec   |Sat | 2016.959|   17| 352|   51|        2|       4|\n|2017-02-13   | 2017|Feb   |Mon | 2017.118|   13|  44|    7|        1|       1|\n|2017-04-05   | 2017|Apr   |Wed | 2017.258|    5|  95|   14|        1|       2|\n\n\n:::\n:::\n\n\n\n## `arrival_date` date features\n\nAdding `label = FALSE`\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n\n\n|arrival_date | year| month| dow|  decimal| mday| doy| week| semester| quarter|\n|:------------|----:|-----:|---:|--------:|----:|---:|----:|--------:|-------:|\n|2016-08-30   | 2016|     8|   3| 2016.661|   30| 243|   35|        2|       3|\n|2016-10-22   | 2016|    10|   7| 2016.806|   22| 296|   43|        2|       4|\n|2016-12-17   | 2016|    12|   7| 2016.959|   17| 352|   51|        2|       4|\n|2017-02-13   | 2017|     2|   2| 2017.118|   13|  44|    7|        1|       1|\n|2017-04-05   | 2017|     4|   4| 2017.258|    5|  95|   14|        1|       2|\n\n\n:::\n:::\n\n\n\n## Other recipes steps\n\n- [`step_time()`](https://recipes.tidymodels.org/reference/step_date.html)\n\nWorks the same as `step_date()` but for measurements smaller than day: hour, hour12, am/pm, minute, second, decimal_day.\n\n- [`step_holiday()`](https://recipes.tidymodels.org/reference/step_holiday.html)\n\nAdds indicators for holidays. See `timeDate::listHolidays()` for supported holidays.\n\n## Your turn\n\n![](images/parsnip-flagger.jpg){.absolute top=\"0\" right=\"0\" width=\"150\" height=\"150\"}\n\n*Apply date steps to the `arrival_date` variable and try to see if we capture anything about `avg_price_per_room`*\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"countdown\" id=\"step_date-step_holiday-arrival_date\" data-update-every=\"1\" tabindex=\"0\" style=\"right:0;bottom:0;\">\n<div class=\"countdown-controls\"><button class=\"countdown-bump-down\">&minus;</button><button class=\"countdown-bump-up\">&plus;</button></div>\n<code class=\"countdown-time\"><span class=\"countdown-digits minutes\">03</span><span class=\"countdown-digits colon\">:</span><span class=\"countdown-digits seconds\">00</span></code>\n</div>\n```\n\n:::\n:::\n\n\n\n## dates as numerics\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](advanced-05-feature-engineering-part-two_files/figure-revealjs/step-date-label-false-1.svg)\n:::\n:::\n\n\n\n## holidays as numerics\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](advanced-05-feature-engineering-part-two_files/figure-revealjs/step-holiday-1.svg)\n:::\n:::\n\n\n\n## What are the issues with these features?\n\nThe numeric features make it easy to capture the end or beginning, but harder to do anything more granular.\n\nThe indicators mostly care about the day itself. No information about the lead-up or aftermath\n\n## time events\n\nUsing `extrasteps::step_time_event()` and the [almanac](https://davisvaughan.github.io/almanac/index.html) package, we can create useful time features.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(almanac)\n\nrule_1 <- weekly() |>\n  recur_on_weekdays() |>\n  rsetdiff(hol_christmas())\n\nrule_2 <- monthly(since = \"2000-01-01\") |>\n  recur_on_interval(3) |>\n  recur_on_day_of_month(1)\n\nrule_3 <- yearly(\"1997-06-05\") |>\n  recur_on_day_of_week(\"Thursday\") |>\n  recur_on_month_of_year(c(\"Jun\", \"July\", \"Aug\"))\n```\n:::\n\n\n\n## `step_time_event()`  ![](hexes/recipes.png){.absolute top=-20 right=0 width=\"64\" height=\"74.24\"}\n\nCreate a list of rules (last slide) and pass them to the `rules` argument of [`extrasteps::step_time_event()`](https://emilhvitfeldt.github.io/extrasteps/reference/step_time_event.html)\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrules <- list(rule_1 = rule_1, rule_2 = rule_2, rule_3 = rule_3)\n\nrecipe(~arrival_date, data = hotel_rates) |>\n  step_time_event(arrival_date, rules = rules)\n```\n:::\n\n\n\n::: {.absolute bottom=0 right=0}\n[FEAZ](https://feaz-book.com/datetime-advanced)\n:::\n\n## `step_time_event()` as numerics  ![](hexes/recipes.png){.absolute top=-20 right=0 width=\"64\" height=\"74.24\"}\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](advanced-05-feature-engineering-part-two_files/figure-revealjs/step-time-event-figure-1.svg)\n:::\n:::\n\n\n\n## Non-indicator time events\n\nThese features still have the issue that they only attach value to the date itself.\n\nWe can attach values based on how far we are away from those dates.\n\n- [`step_date_before()`](https://emilhvitfeldt.github.io/extrasteps/reference/step_date_before.html)\n- [`step_date_after()`](https://emilhvitfeldt.github.io/extrasteps/reference/step_date_after.html)\n- [`step_date_nearest()`](https://emilhvitfeldt.github.io/extrasteps/reference/step_date_nearest.html)\n\n## `step_date_before()`\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](advanced-05-feature-engineering-part-two_files/figure-revealjs/step-date-before-1.svg)\n:::\n:::\n\n\n\n## `step_date_before()` - inverse\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](advanced-05-feature-engineering-part-two_files/figure-revealjs/step-date-before-inverse-1.svg)\n:::\n:::\n\n\n\n## `step_date_after()` - inverse\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](advanced-05-feature-engineering-part-two_files/figure-revealjs/step-date-after-inverse-1.svg)\n:::\n:::\n\n\n\n## `step_date_nearest()` - inverse\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](advanced-05-feature-engineering-part-two_files/figure-revealjs/step-date-nearest-inverse-1.svg)\n:::\n:::\n\n\n\n## Datetime features\n\nAvoid crafting datetime features by hand if at all possible.\n\nDealing with uneven month lengths, leap days (leap seconds)\n\nOr tried to define any event that doesn't land on the same day of the week or date each year.\n\n> The first Sunday after the first full moon on or after the vernal equinox\n",
    "supporting": [
      "advanced-05-feature-engineering-part-two_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../../site_libs/countdown-0.4.0/countdown.css\" rel=\"stylesheet\" />\n<script src=\"../../../site_libs/countdown-0.4.0/countdown.js\"></script>\n"
      ],
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}